# RoboMaster 英雄底盘C板控制项目技术文档

## 目录

1. [项目概述](#项目概述)
2. [硬件平台](#硬件平台)
3. [项目结构](#项目结构)
4. [核心模块](#核心模块)
5. [任务架构](#任务架构)
6. [控制算法](#控制算法)
7. [硬件接口](#硬件接口)
8. [关键配置文件](#关键配置文件)
9. [使用说明与安全注意事项](#使用说明与安全注意事项)

---

## 项目概述

本项目是 RoboMaster 2023 赛季步兵机器人（英雄底盘）电控C板代码仓库，基于 STM32F4 标准库和 FreeRTOS 实时操作系统开发。

### 主要功能

- **底盘控制**: 四轮麦克纳姆轮底盘，支持全向移动、小陀螺模式、小猫步模式
- **云台控制**: 双轴云台（YAW/PITCH），支持与底盘联动/分离模式
- **发射系统**: 双摩擦轮+单拨弹电机，支持射速控制与热量管理
- **姿态解算**: 基于 BMI088 IMU 的姿态传感器数据融合
- **通信系统**: 与裁判系统、上位机的双向通信
- **功率管理**: 底盘功率缓冲与超级电容控制

### 新特性

- 新增 USB CDC 外设，小电脑和32的连接无需串口TTL模块，仅需一根 Micro USB 线

---

## 硬件平台

### 主控芯片

| 参数 | 规格 |
|------|------|
| 芯片型号 | STM32F407IGHx |
| 架构 | ARM Cortex-M4F |
| 主频 | 168 MHz |
| FPU | 硬件浮点单元 |
| Flash | 1 MB |
| SRAM | 192 KB |

### 传感器与外设

- **IMU**: BMI088 (6轴加速度计+陀螺仪)
- **CAN总线**: CAN1、CAN2
- **UART**: UART1(遥控器)、UART3(裁判系统)、UART6(上位机)
- **USB**: USB CDC (虚拟串口)

### 电机配置

| 位置 | 电机型号 | CAN ID | 数量 |
|------|---------|--------|------|
| 底盘轮子 | M3508 | 0x201-0x204 | 4 |
| 云台YAW | M6020 | 0x20A | 1 |
| 云台PITCH | M6020 | 0x20B | 1 |
| 拨弹电机 | M3508/M2006 | 0x208 | 1 |
| 摩擦轮 | M3508 | 0x205/0x206 | 2 |

---

## 项目结构

```
Hero_Chassis_C_Board/
├── TASK/              # 任务模块
│   ├── chassis_task.c/h       # 底盘控制任务
│   ├── gimbal_task.c/h        # 云台控制任务
│   ├── shoot_task.c/h         # 发射控制任务
│   ├── imu_task.c/h           # 姿态解算任务
│   ├── modeswitch_task.c/h    # 模式切换任务
│   ├── detect_task.c/h        # 设备检测任务
│   ├── info_get_task.c/h      # 数据获取任务
│   ├── judge_task.c/h         # 裁判系统任务
│   ├── pc_task.c/h            # 上位机通信任务
│   └── comm_task.c/h          # CAN通信任务
│
├── FUNTION/           # 算法库
│   ├── pid.c/h                # PID控制算法
│   ├── fuzzy_pid.c/h          # 模糊PID控制算法
│   ├── ladrc.c/h              # 线性自抗扰控制(LADRC)
│   ├── ramp.c/h               # 斜坡限幅函数
│   ├── power_control.c/h      # 功率控制算法
│   ├── remote_ctrl.c/h        # 遥控器处理
│   └── keyboard.c/h           # 键盘控制
│
├── PROTOCOL/           # 通信协议
│   ├── protocol.c/h            # 协议基础函数
│   ├── data_packet.c/h         # 数据包封装
│   ├── data_fifo.c/h           # FIFO队列
│   ├── judge_rx_data.c/h       # 裁判系统接收
│   ├── judge_tx_data.c/h       # 裁判系统发送
│   ├── pc_rx_data.c/h          # 上位机接收
│   └── pc_tx_data.c/h          # 上位机发送
│
├── BSP_CONF/           # 板级支持包配置
│   ├── bsp_can.c/h             # CAN驱动
│   ├── bsp_imu.c/h             # IMU驱动
│   ├── bsp_flash.c/h           # Flash驱动
│   ├── bsp_dwt.c/h             # DWT计时器
│   ├── bsp_iwdg.c/h            # 独立看门狗
│   └── bsp_usb.c/h             # USB驱动
│
├── USER_CONF/          # 用户配置文件
│   ├── sys_config.h            # 系统全局配置(重要!)
│   ├── can.c/h                 # CAN外设配置
│   ├── usart.c/h               # UART外设配置
│   ├── spi.c/h                 # SPI外设配置
│   ├── tim.c/h                 # 定时器配置
│   ├── gpio.c/h                # GPIO配置
│   ├── dma.c/h                 # DMA配置
│   ├── rc.c/h                  # 遥控器配置
│   ├── start_tack.c/h          # 任务启动配置
│   └── st_usb_cdc.c/h          # USB CDC配置
│
├── BMI088/             # BMI088传感器驱动
│   ├── devices/                # 底层驱动
│   │   ├── BMI088driver.c/h    # 驱动接口
│   │   ├── BMI088Middleware.c/h # 中间层
│   │   └── BMI088reg.h         # 寄存器定义
│   └── algorithm/              # 算法库
│       ├── MahonyAHRS.c/h      # Mahony姿态解算
│       ├── filters.c/h         # 滤波器
│       └── AHRS_middleware.c/h # 中间层接口
│
├── FreeRTOS/           # FreeRTOS源码
├── FWLIB/              # STM32F4标准外设库
├── USB_LIB/            # USB设备库
├── CORE/               # CMSIS核心文件
├── USER/               # 用户主程序
│   └── main.c                  # 主函数入口
└── build/              # 编译输出目录
```

---

## 核心模块

### 1. 底盘控制 (chassis_task)

#### 功能概述
底盘控制模块负责麦克纳姆轮底盘的运动控制，实现全向移动功能。

#### 主要结构体

```c
typedef struct
{
  uint8_t         dodge_ctrl;      // 小陀螺控制标志
  uint8_t         separt_ctrl;     // 分离控制标志
  uint8_t         direction;       // 运动方向
  float           vx;              // 前进后退速度(m/s)
  float           vy;              // 左右平移速度(m/s)
  float           vw;              // 旋转角速度(rad/s)
  int16_t         wheel_spd_fdb[4]; // 轮速反馈值
  int16_t         wheel_spd_ref[4]; // 轮速参考值
  int16_t         current[4];       // 电机电流值
  double          CapData[4];       // 电容数据
  uint8_t         cap_volt_warning; // 电容电压警告
  uint8_t         fast_flag;        // 加速模式标志
  uint8_t         Speed_up;         // 冲锋模式标志
  float           ob_total_power;   // 当前总功率
  float           cap_store;        // 电容存储能量(默认27J)
}chassis_wheel_t;
```

#### 控制模式

| 模式 | 说明 | 特点 |
|------|------|------|
| CHASSIS_NORMAL_MODE | 正常模式 | 云台底盘联动，跟随云台方向移动 |
| CHASSIS_SEPARATE_MODE | 分离模式 | 云台底盘分离，底盘固定朝向 |
| CHASSIS_DODGE_MODE | 小陀螺模式 | 底盘持续旋转，提高生存能力 |
| CHASSIS_STOP_MODE | 停止模式 | 底盘不运动 |

#### 速度参数

| 参数 | 遥控器模式 | 键盘模式 | 单位 |
|------|-----------|---------|------|
| 最大X速度 | 3300 | 4000 | mm/s |
| 最大Y速度 | 3300 | 4000 | mm/s |
| 最大旋转速度 | 480 | - | deg/s |

---

### 2. 云台控制 (gimbal_task)

#### 功能概述
云台控制模块负责双轴云台(YAW/PITCH)的角度控制，实现目标瞄准和跟踪功能。

#### 主要结构体

```c
typedef struct
{
  /* 角度环的各个变量头 */
  float yaw_angle_ref;       // YAW角度参考值
  float pit_angle_ref;       // PITCH角度参考值
  float yaw_angle_fdb;       // YAW角度反馈值
  float pit_angle_fdb;       // PITCH角度反馈值
  /* 速度环的各个变量头 */
  float yaw_spd_ref;         // YAW速度参考值
  float pit_spd_ref;         // PITCH速度参考值
  float yaw_spd_fdb;         // YAW速度反馈值
  float pit_spd_fdb;         // PITCH速度反馈值
} gim_pid_t;

typedef struct
{
  /* 相对角度(机械零点为基准) */
  float pit_relative_angle;
  float yaw_relative_angle;
  float roll_relative_angle;
  float pit_gyro_angle;
  float yaw_gyro_angle;
  float roll_gyro_angle;
  /* 角速度 */
  float yaw_palstance;
  float pit_palstance;
  float roll_palstance;

  float yaw_total_angle;
  int32_t yaw_cnt;
} gim_sensor_t;
```

#### 云台模式

| 模式 | 说明 |
|------|------|
| GIMBAL_INIT | 初始化模式，云台中值校准 |
| GIMBAL_NORMAL_MODE | 正常模式，与底盘联动 |
| GIMBAL_SEPARATE_MODE | 分离模式，独立于底盘 |
| GIMBAL_DODGE_MODE | 小陀螺模式 |
| GIMBAL_SHOOT_BUFF | 补弹模式 |
| GIMBAL_TRACK_ARMOR | 装甲板追踪(视觉) |

#### 角度限位

| 轴 | 最小角度 | 最大角度 |
|----|---------|---------|
| YAW | -50° | 50° |
| PITCH | 可配置 | 可配置 |

---

### 3. 发射控制 (shoot_task)

#### 功能概述
发射控制模块负责摩擦轮和拨弹电机的控制，实现发射功能和热量管理。

#### 主要结构体

```c
typedef struct
{
  uint8_t fric_trun_on;       // 摩擦轮开启标志
  uint8_t last_para_mode;     // 上一次弹道模式
  uint8_t para_mode;          // 弹道模式
  uint8_t loader_fire_allow;  // 拨弹允许标志
} shoot_t;

typedef struct
{
  int32_t angle_ref;          // 拨弹角度参考值
  int32_t spd_ref;            // 拨弹速度参考值
} loader_t;
```

#### 关键参数

| 参数 | 值 | 说明 |
|------|-----|------|
| DEFAULT_FRIC_WHEEL_SPEED | 2000 | 摩擦轮默认转速(max: 2500) |
| TRIGGER_MOTOR_SPEED | -2000 | 拨弹电机转速 |
| C_TRIGGER_MOTOR_SPEED | -3000 | 下拨弹电机转速 |

---

### 4. IMU任务 (imu_task)

#### 功能概述
IMU任务负责读取BMI088传感器数据并进行姿态解算，提供实时姿态信息。

#### 姿态数据结构

```c
typedef struct
{
  int roll_cnt;
  int pitch_cnt;
  int yaw_cnt;

  float last_roll;
  float last_pitch;
  float last_yaw;

  float roll;
  float pitch;
  float yaw;
} imu_attitude_t;
```

#### 传感器参数

| 参数 | 说明 |
|------|------|
| 传感器 | BMI088 (6轴IMU) |
| 算法 | Mahony AHRS |
| 任务周期 | 1ms |
| 温度控制 | 50°C |

---

### 5. 通信协议 (PROTOCOL文件夹)

#### 协议概述
通信协议模块负责与裁判系统和上位机的数据交换，采用自定义帧格式。

#### 帧头结构

```c
typedef struct
{
  uint8_t  sof;              // 帧起始标志 (0xA5)
  uint16_t data_length;      // 数据长度
  uint8_t  seq;              // 序列号
  uint8_t  crc8;             // CRC8校验
} frame_header_t;
```

#### 通信接口

| 接口 | UART | 功能 |
|------|------|------|
| 遥控器 | UART1 | 接收遥控器指令 |
| 裁判系统 | UART3 | 双向通信，获取比赛状态 |
| 上位机 | UART6 | 双向通信，视觉数据 |

---

### 6. 模式切换 (modeswitch_task)

#### 功能概述
模式切换任务根据遥控器开关状态和上位机指令，切换系统的运行模式。

#### 全局状态

```c
typedef enum
{
  RELEASE_CTRL,           // 释放控制
  MANUAL_CTRL,            // 手动控制
  SEMI_AUTOMATIC_CTRL,    // 半自动控制
}global_status;
```

#### 云台状态

```c
typedef enum
{
  GIMBAL_RELEASE,         // 云台释放
  GIMBAL_INIT,            // 云台初始化
  GIMBAL_NORMAL_MODE,     // 正常模式
  GIMBAL_SEPARATE_MODE,   // 分离模式
  GIMBAL_DODGE_MODE,      // 小陀螺模式
  GIMBAL_SHOOT_BUFF,      // 补弹模式
  GIMBAL_TRACK_ARMOR,     // 装甲板追踪
}gimbal_status;
```

#### 底盘状态

```c
typedef enum
{
  CHASSIS_RELEASE,        // 底盘释放
  CHASSIS_NORMAL_MODE,    // 正常模式
  CHASSIS_SEPARATE_MODE,  // 分离模式
  CHASSIS_DODGE_MODE,     // 小陀螺模式
  CHASSIS_STOP_MODE,      // 停止模式
}chassis_status;
```

---

### 7. 检测任务 (detect_task)

#### 功能概述
检测任务监控各设备的工作状态，检测离线故障。

#### 错误ID定义

```c
typedef enum
{
  BOTTOM_DEVICE,                  // 底层设备
  CHASSIS_M1_OFFLINE,            // 底盘M1离线
  CHASSIS_M2_OFFLINE,            // 底盘M2离线
  CHASSIS_M3_OFFLINE,            // 底盘M3离线
  CHASSIS_M4_OFFLINE,            // 底盘M4离线
  GIMBAL_YAW_OFFLINE,            // 云台YAW离线
  GIMBAL_PIT_OFFLINE,            // 云台PITCH离线
  TRIGGER_MOTO_OFFLINE_FRONT,    // 前拨弹电机离线
  FRI_MOTO1_OFFLINE,             // 摩擦轮1离线
  FRI_MOTO2_OFFLINE,             // 摩擦轮2离线
  IMU_OFFLINE,                   // IMU离线
  REMOTE_CTRL_OFFLINE,           // 遥控器离线
  JUDGE_SYS_OFFLINE,             // 裁判系统离线
  PC_SYS_OFFLINE,                // 上位机离线
  TRIGGER_MOTO_OFFLINE_REAR,     // 后拨弹电机离线
  ERROR_LIST_LENGTH              // 错误列表长度
}err_id;
```

---

## 任务架构

### FreeRTOS任务列表

本项目使用 FreeRTOS 实时操作系统，各任务优先级和堆栈大小如下：

| 任务名称 | 优先级 | 堆栈大小 | 说明 |
|---------|--------|---------|------|
| start_task | 2 | 128 | 启动任务，创建其他所有任务 |
| gimbal_task | 5 | 128 | 云台控制任务 |
| chassis_task | 5 | 256 | 底盘控制任务 |
| shoot_task | 5 | 128 | 发射控制任务 |
| can_msg_send_task | 6 | 128 | CAN消息发送任务 |
| mode_switch_task | 6 | 128 | 模式切换任务 |
| info_get_task | 4 | 128 | 数据获取任务 |
| detect_task | 4 | 128 | 设备检测任务 |
| imu_task | 4 | 128 | IMU姿态解算任务 |
| judge_tx_task | 4 | 256 | 裁判系统发送任务 |
| judge_rx_task | 4 | 256 | 裁判系统接收任务 |
| pc_tx_task | 4 | 256 | 上位机发送任务 |
| pc_rx_task | 4 | 256 | 上位机接收任务 |

### 任务优先级说明

- **优先级6 (最高)**: CAN消息发送、模式切换 - 保证实时性
- **优先级5 (高)**: 云台、底盘、发射 - 核心控制任务
- **优先级4 (中)**: IMU、检测、通信 - 数据处理任务
- **优先级2 (低)**: 启动任务 - 仅用于初始化

### 任务通信

任务间主要通过任务通知(Task Notification)进行同步：

```c
xTaskNotifyWait((uint32_t)NULL,
                (uint32_t)INFO_GET_CHASSIS_SIGNAL,
                (uint32_t *)&Signal,
                (TickType_t)portMAX_DELAY);
```

---

## 控制算法

### 1. PID控制

#### 基本PID结构

```c
typedef struct pid
{
  float set;              // 目标值
  float get;              // 反馈值
  float error[3];         // 误差(当前, 上一次, 上上次)

  float kp;               // 比例系数
  float ki;               // 积分系数
  float kd;               // 微分系数

  float pout;             // 比例输出
  float iterm;            // 积分项(抗饱和)
  float iout;             // 积分输出
  float dout;             // 微分输出
  float out;              // 总输出

  int32_t maxout;         // 输出限幅
  int32_t integral_limit; // 积分限幅
  float output_deadband;  // 输出死区
}pid_t;
```

#### PID控制器列表

| PID名称 | 用途 |
|---------|------|
| pid_yaw | 云台YAW角度环 |
| pid_pit | 云台PITCH角度环 |
| pid_yaw_spd | 云台YAW速度环 |
| pid_pit_spd | 云台PITCH速度环 |
| pid_chassis_vx_vy_spd[4] | 底盘4轮速度环 |
| pid_chassis_cali_angle | 底盘校准角度 |
| pid_chassis_vw | 底盘旋转速度环 |
| pid_chassis_power_buffer | 功率缓冲控制 |
| pid_loader_angle | 拨弹角度环 |
| pid_loader_spd | 拨弹速度环 |
| pid_fric[2] | 摩擦轮速度环 |
| pid_heat_limit | 热量限制 |
| pid_imu_tmp | IMU温度控制 |

---

### 2. 模糊PID控制

#### 模糊PID特点

- 根据误差和误差变化率动态调整PID参数
- 提高系统的自适应性和鲁棒性
- 适用于非线性、时变系统

#### 模糊参数

```c
typedef struct
{
  float e;                  // 误差
  float de;                 // 误差变化率
  float e_max;              // 误差量化最大值
  float de_max;             // 误差变化率量化最大值
  float Kp_max;             // PID比例最大值
  float Ki_max;             // PID积分最大值
  float Kd_max;             // PID微分最大值
  float Ke;                 // 误差量化因子
  float Kde;                // 误差变化率量化因子
  float Ku_p;               // 比例量化因子
  float Ku_i;               // 积分量化因子
  float Ku_d;               // 微分量化因子
  float percent;            // 模糊推理输出
}fuzzy_pid;
```

---

### 3. 线性自抗扰控制 (LADRC)

#### LADRC特点

- 无需精确的数学模型
- 强抗干扰能力
- 适用于摩擦轮速度控制

#### LADRC结构

```c
typedef struct LADRC
{
  float v1, v2;            // 最速输出值
  float r;                 // 速度因子
  float h;                 // 积分步长
  float z1, z2, z3;        // 扩张状态观测器(ESO)输出
  float w0, wc, b0, u;     // 观测器带宽, 控制器带宽, 系统参数, 控制器输出
  int32_t maxout;
} LADRC_NUM;
```

#### 使用方法

```c
// 初始化
LADRC_Init(&Fric_speed, h, r, wc, w0, b0, max_out);

// 循环控制
output = LADRC_Loop(&Fric_speed, set, get);

// 复位
LADRC_REST(&Fric_speed);
```

---

### 4. 功率控制算法

#### 功率管理参数

| 参数 | 值 | 说明 |
|------|-----|------|
| Debug_Power | 70 | 无裁判系统时的功率限制 |
| Deta_Power | 60 | 超级电容功率缓冲 |
| CAP_LOW | 11 | 电容电压低于14V报警 |
| BUFFER_ENERGY_REF | 55 | 目标缓冲能量 |

#### 功能接口

```c
float Chassis_Power_Control(chassis_wheel_t *chassis_power_control);
```

---

## 硬件接口

### 1. CAN总线

#### CAN1连接

| 设备 | 接收ID | 发送ID |
|------|--------|--------|
| 底盘M1(右前) | 0x201 | 0x200 |
| 底盘M2(左前) | 0x202 | 0x200 |
| 底盘M3(左后) | 0x203 | 0x200 |
| 底盘M4(右后) | 0x204 | 0x200 |
| 拨弹电机 | 0x208 | 0x1FF |
| 超级电容 | 0x211 | 0x210 |

#### CAN2连接

| 设备 | 接收ID | 发送ID |
|------|--------|--------|
| 云台YAW | 0x20A | 0x2FF |
| 云台PITCH | 0x20B | 0x2FF |
| 摩擦轮1 | 0x205 | 0x1FF |
| 摩擦轮2 | 0x206 | 0x1FF |
| 云台主控板 | 0x101 | 0x306/0x307 |

#### CAN数据结构

```c
typedef struct
{
  uint16_t ecd;               // 编码器值
  uint16_t last_ecd;          // 上次编码器值
  int16_t  speed_rpm;         // 转速(RPM)
  int16_t  given_current;     // 给定电流
  int32_t  round_cnt;         // 圈数
  int32_t  total_ecd;         // 总编码器值
  int32_t  total_angle;       // 总角度
  uint16_t offset_ecd;        // 零点偏移
  uint32_t msg_cnt;           // 消息计数
  int32_t  ecd_raw_rate;      // 原始变化率
  int32_t  rate_buf[5];       // 滤波缓冲
  int32_t  filter_rate;       // 滤波后变化率
} moto_measure_t;
```

---

### 2. UART串口

| 串口 | 波特率 | 功能 |
|------|--------|------|
| UART1 | 100000 | 遥控器通信(DBUS) |
| UART3 | 115200 | 裁判系统通信 |
| UART6 | 115200 | 上位机通信(MINI PC) |

---

### 3. 其他外设

| 外设 | 用途 |
|------|------|
| SPI | BMI088传感器通信 |
| GPIO | LED指示灯、按键等 |
| DMA | UART、CAN数据传输 |
| USB CDC | 虚拟串口，替代USB转TTL |

---

## 关键配置文件

### sys_config.h

这是系统的核心配置文件，定义了所有关键参数。

#### 机器人类型

```c
#define HERO    1    // 英雄机器人
```

#### 小陀螺模式

```c
#define LG      1    // 螺旋小陀螺
#define TWIST   2    // 旋转小陀螺

#define DODGE_MODE LG  // 当前使用模式
```

#### 遥控器参数

```c
#define RC_RESOLUTION     660.0f  // 遥控器分辨率
```

#### 底盘速度参数

```c
// 遥控器模式
#define CHASSIS_RC_MAX_SPEED_X  3300.0f
#define CHASSIS_RC_MAX_SPEED_Y  3300.0f
#define CHASSIS_RC_MAX_SPEED_R  480.0f
#define CHASSIS_RC_MOVE_RATIO_X 0.7f
#define CHASSIS_RC_MOVE_RATIO_Y 0.7f
#define CHASSIS_RC_MOVE_RATIO_R 1.0f

// 键盘模式
#define CHASSIS_KB_MAX_SPEED_X  4000.0f
#define CHASSIS_KB_MAX_SPEED_Y  4000.0f
```

#### 云台速度参数

```c
// 遥控器模式
#define GIMBAL_RC_MOVE_RATIO_PIT -1.5f
#define GIMBAL_RC_MOVE_RATIO_YAW 3.0f

// 上位机模式
#define GIMBAL_PC_MOVE_RATIO_PIT 1.0f
#define GIMBAL_PC_MOVE_RATIO_YAW 1.0f
```

#### 发射参数

```c
#define SAFE_SHOOT_FLAG 0              // 发射安全标志
#define DEFAULT_FRIC_WHEEL_SPEED 2000  // 摩擦轮默认转速
#define TRIGGER_MOTOR_SPEED -2000      // 拨弹电机转速
```

#### 机械参数

```c
#define RADIUS      76   // 轮子半径(mm)
#define PERIMETER   478  // 轮子周长(mm)
#define WHEELTRACK  376  // 轮距(mm)
#define WHEELBASE   455  // 轴距(mm)
```

#### 底盘电机参数

```c
#define CHASSIS_DECELE_RATIO (1.0f/19.0f)  // 减速比
#define MAX_WHEEL_RPM       8500            // 最大轮速(RPM)
#define MAX_CHASSIS_VX_SPEED 3300          // 最大X速度(mm/s)
#define MAX_CHASSIS_VY_SPEED 3300          // 最大Y速度(mm/s)
#define MAX_CHASSIS_VR_SPEED 360           // 最大旋转速度(deg/s)
```

#### 云台电机参数

```c
#define ENCODER_ANGLE_RATIO (8192.0f/360.0f)  // 编码器分辨率
#define PIT_DECELE_RATIO  1.0f                // PITCH减速比
#define YAW_DECELE_RATIO  1.0f                // YAW减速比
```

#### 小陀螺参数

```c
#define LG_SPEED        210   // 螺旋小陀螺速度
#define MAX_DODGE_SPEED 400   // 小猫步最大速度
```

#### 角度限位

```c
#define YAW_ANGLE_MAX  50
#define YAW_ANGLE_MIN  -50
```

#### 常量定义

```c
#define RADIAN_COEF    57.3f   // 弧度转角度
#define PI             3.142f  // 圆周率
#define NATURAL_NUM_E  2.718282f  // 自然常数
```

#### LED定义

```c
#define LED_RED   GPIO_Pin_12    // 红色LED
#define LED_GREEN GPIO_Pin_11    // 绿色LED
#define LED_BLUE  GPIO_Pin_10    // 蓝色LED
```

---

## 使用说明与安全注意事项

### 1. 供电安全

#### 电源要求

- **主电源**: 24V 锂电池组
- **电压范围**: 20V - 26.4V
- **保护**: 欠压保护、过流保护

#### 超级电容

- **作用**: 提供瞬时功率缓冲
- **电压**: 正常工作电压约24V
- **警告**: 低于11V时触发电压警告

### 2. 控制安全

#### 安全发射

```c
#define SAFE_SHOOT_FLAG 0  // 默认为0，允许发射
```
- 设置为1时，禁止发射
- 比赛前务必确认安全区域

#### 摩擦轮安全

- 摩擦轮高速旋转，严禁用手触碰
- 开启前确保无异物
- 最大转速: 2500

#### 功率管理

- 无裁判系统时功率限制: 70W
- 有超级电容时缓冲: 60W
- 超出限制时自动降速

### 3. 操作注意事项

#### 启动顺序

1. 连接电源线
2. 打开主控板电源
3. 连接遥控器
4. 等待初始化完成(LED指示)
5. 开始操作

#### 遥控器操作

- **左拨杆**: 控制底盘前后左右移动
- **右拨杆**: 控制云台角度
- **左开关**: 底盘模式切换
- **右开关**: 云台模式切换

#### 键盘操作

- **WASD**: 底盘移动
- **Q/E**: 云台YAW控制
- **Shift/Ctrl**: 速度调整

### 4. 调试注意事项

#### 调试模式

```c
#define DEBUG  // 开启调试模式
```

#### PID调参步骤

1. 先调速度环，再调角度环
2. 比例系数从小到大
3. 积分系数消除稳态误差
4. 微分系数抑制超调
5. 使用调试工具实时监控

#### 通信测试

- 确认CAN总线连接正确
- 检查ID配置是否匹配
- 使用CAN分析仪监控通信

### 5. 代码修改注意事项

#### 修改配置

- 主要修改 `sys_config.h`
- 修改后重新编译
- 注意参数单位和范围

#### 添加功能

- 在对应模块添加代码
- 遵循现有代码风格
- 注意任务同步

#### 版本管理

- 使用Git进行版本管理
- 新建分支开发
- 提交时写清楚修改说明

### 6. 常见问题处理

#### 电机不转

1. 检查CAN连接
2. 检查电机ID配置
3. 检查电源电压
4. 查看错误码

#### 云台抖动

1. 检查PID参数
2. 检查机械结构
3. 降低控制频率
4. 添加滤波

#### 功率不足

1. 检查电池电量
2. 检查超级电容状态
3. 调整功率限制参数
4. 降低运动速度

### 7. 维护建议

#### 日常维护

- 定期检查紧固件
- 清理灰尘和异物
- 检查线缆连接
- 更新固件版本

#### 比赛前检查

- 全功能测试
- 通信测试
- 功率测试
- 安全检查

---

## 附录

### A. 编译说明

#### 开发环境

- IDE: Keil uVision 5
- 编译器: ARMCC
- 调试器: ST-Link V2

#### 编译步骤

1. 打开工程文件 `Hero_Chassis_C_board.uvprojx`
2. 选择目标配置
3. 点击编译按钮
4. 下载到板子

#### 清理编译文件

运行 `keilkilll.bat` 清理编译生成的文件

### B. Git使用说明

#### 克隆仓库

```bash
git clone https://jihulab.com/awakelion-robot-lab/control-group/standard-robot.git
```

#### 创建分支

```bash
git checkout -b my-feature
```

#### 提交更改

```bash
git add .
git commit -m "修改说明"
git push origin my-feature
```

#### 版本回退

```bash
# 查看历史
git log

# 回退到指定版本
git reset --hard <commit_id>
```

### C. 开发规范

#### 命名规范

- 文件名: 小写+下划线 (如 `chassis_task.c`)
- 函数名: 小写+下划线 (如 `chassis_normal_handler`)
- 结构体: 小写+下划线+_t (如 `chassis_wheel_t`)
- 宏定义: 大写+下划线 (如 `MAX_CHASSIS_SPEED`)

#### 注释规范

```c
/**
 * @brief 函数简述
 * @param param1 参数1说明
 * @param param2 参数2说明
 * @return 返回值说明
 */
```

#### 代码风格

- 缩进: 2空格
- 大括号: K&R风格
- 行宽: 不超过80字符

---

## 文档更新记录

| 版本 | 日期 | 修改人 | 修改内容 |
|------|------|--------|---------|
| 1.0 | 2024-01-22 | swooooo | 初始版本 |

---

## 联系方式

如有问题或建议，请联系项目维护者。

---

**祝比赛顺利！加油！** 🚀
